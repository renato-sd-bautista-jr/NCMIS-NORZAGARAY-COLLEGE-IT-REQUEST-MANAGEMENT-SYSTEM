<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Code Generator - NCMIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="flex min-h-screen bg-gray-200 text-gray-800">

  <!-- Sidebar -->
  <aside id="sidebar"
    class="fixed top-0 left-0 h-full w-64 bg-[#1E293B] text-gray-100 flex flex-col justify-between shadow-xl z-50 transform transition-transform duration-300 md:translate-x-0 -translate-x-full">

    <!-- Logo -->
    <div>
      <div class="mb-8 text-center border-b border-blue-500 pb-5 mt-4">
        <h4 class="text-3xl font-extrabold tracking-wide text-white">NCMIS</h4>
        <span class="text-blue-300 text-sm">Inventory Dashboard</span>
      </div>

      <!-- Navigation -->
      <nav class="flex flex-col gap-2 px-4">
        <!-- Dashboard -->
        <a href="{{ url_for('dashboard_bp.dashboard_load') }}"
           class="flex items-center px-4 py-3 rounded-lg font-medium text-gray-200 transition-all duration-200
                  {% if request.endpoint == 'invendash_bp.dashboard_page' %}
                    bg-blue-600 text-white shadow-md
                  {% else %}
                    hover:bg-blue-600/30 hover:text-white
                  {% endif %}">
          <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
        </a>

        <!-- Manage Items -->
        <a href="{{ url_for('manage_item_bp.manage_items_page') }}"
           class="flex items-center px-4 py-3 rounded-lg font-medium text-gray-200 transition-all duration-200
                  {% if request.endpoint == 'manage_item' %}
                    bg-blue-600 text-white shadow-md
                  {% else %}
                    hover:bg-blue-600/30 hover:text-white
                  {% endif %}">
          <i data-lucide="package" class="w-5 h-5 mr-3"></i> Manage Items
        </a>

        <!-- Inventory -->
        <a href="{{ url_for('manage_pc_bp.inventory') }}"
           class="flex items-center px-4 py-3 rounded-lg font-medium text-gray-200 transition-all duration-200 hover:bg-blue-600/30 hover:text-white">
          <i data-lucide="cpu" class="w-5 h-5 mr-3"></i> Inventory
        </a>

        <!-- QR List -->
        <a href="{{ url_for('qrcode_bp.qrcode_generator_page') }}"
           class="flex items-center px-4 py-3 rounded-lg font-medium text-gray-200 transition-all duration-200 hover:bg-blue-600/30 hover:text-white">
          <i data-lucide="qr-code" class="w-5 h-5 mr-3"></i> QR List
        </a>

        <!-- Report -->
        <a href="{{ url_for('report_bp.report_generator_page') }}"
           class="flex items-center px-4 py-3 rounded-lg font-medium text-gray-200 transition-all duration-200 hover:bg-blue-600/30 hover:text-white">
          <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i> Report
        </a>
      </nav>
    </div>

    <!-- Logout Button -->
    <div class="p-4">
      <button id="logoutBtn"
        class="flex items-center justify-center w-full px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition font-semibold shadow-md">
        <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Logout
      </button>
    </div>
  </aside>

  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black/40 hidden z-40 md:hidden"></div>

  <!-- Main -->
  <main class="flex-1 ml-0 md:ml-64 p-6 space-y-8 transition-all duration-300">

    <!-- Header -->
    <header class="flex items-center justify-between bg-white shadow-md p-4 rounded-xl sticky top-4 z-30">
      <div class="flex items-center gap-3">
        <button id="menu-btn" class="md:hidden p-2 rounded-md hover:bg-gray-100" onclick="toggleSidebar()">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <h2 class="text-2xl font-bold text-blue-600">QR Code Generator</h2>
      </div>
      <button id="addItemBtn"
        class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
        <i data-lucide="plus" class="w-4 h-4"></i> Add QR Item
      </button>
    </header>

    <!-- Items Section -->
    <section class="bg-white rounded-2xl shadow-lg p-6">
      <h3 class="text-lg font-semibold text-blue-700 mb-4">Generated QR Items</h3>
      <div id="itemList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>
  </main>

  <!-- Item Modal -->
  <div id="itemModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-96">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-blue-600">Add Item</h2>
      <form id="itemForm" class="grid gap-3 text-gray-800">
        <input type="hidden" id="editIndex">
        <input id="Department" type="text" placeholder="Department" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="Location" type="text" placeholder="Location" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="Quantity" type="number" placeholder="Quantity" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="AcquisitionCost" type="number" placeholder="Acquisition Cost" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="DateAcquired" type="date" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="Status" type="text" placeholder="Status" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="Accountable" type="text" placeholder="Accountable" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <input id="SerialNo" type="text" placeholder="Serial No" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500">
        <textarea id="Description" placeholder="Description" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 h-20"></textarea>

        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancel</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Logout Modal -->
  <div id="logoutModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 text-center">
      <i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-500 mx-auto mb-3"></i>
      <h2 class="text-lg font-semibold text-blue-600 mb-2">Confirm Logout</h2>
      <p class="text-gray-600 mb-6">Are you sure you want to log out?</p>
      <div class="flex justify-center space-x-3">
        <button id="cancelLogout" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancel</button>
        <form method="post" action="{{ url_for('login_bp.logout') }}">
          <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Logout</button>
        </form>
      </div>
    </div>
  </div>

 <script>
document.addEventListener('DOMContentLoaded', async () => {
  lucide.createIcons();

  // Sidebar toggle
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  window.toggleSidebar = () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  };

  // Logout modal
  const logoutBtn = document.getElementById('logoutBtn');
  const logoutModal = document.getElementById('logoutModal');
  const cancelLogout = document.getElementById('cancelLogout');
  logoutBtn.addEventListener('click', () => logoutModal.classList.remove('hidden'));
  cancelLogout.addEventListener('click', () => logoutModal.classList.add('hidden'));

  // Item management (localStorage version)
  const itemList = document.getElementById('itemList');
  const itemModal = document.getElementById('itemModal');
  const itemForm = document.getElementById('itemForm');
  const addItemBtn = document.getElementById('addItemBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const modalTitle = document.getElementById('modalTitle');
  let items = [], editIndex = null;

  function loadItems() {
    const stored = localStorage.getItem('qrItems');
    items = stored ? JSON.parse(stored) : [];
    renderList();
  }

  function saveItems() {
    localStorage.setItem('qrItems', JSON.stringify(items));
  }

  addItemBtn?.addEventListener('click', () => {
    modalTitle.textContent = "Add Item";
    editIndex = null;
    itemForm.reset();
    itemModal.classList.remove('hidden');
  });

  cancelBtn?.addEventListener('click', () => itemModal.classList.add('hidden'));

  itemForm?.addEventListener('submit', e => {
    e.preventDefault();
    const item = {
      department: Department.value.trim(),
      location: Location.value.trim(),
      quantity: Quantity.value.trim(),
      acquisitionCost: AcquisitionCost.value.trim(),
      dateAcquired: DateAcquired.value,
      status: Status.value.trim(),
      accountable: Accountable.value.trim(),
      serialNo: SerialNo.value.trim(),
      description: Description.value.trim()
    };
    if (Object.values(item).some(v => !v)) return alert("Please fill out all fields!");

    if (editIndex !== null) items[editIndex] = item;
    else items.push(item);
    saveItems();
    renderList();
    itemModal.classList.add('hidden');
  });

  function renderList() {
    itemList.innerHTML = '';
    items.forEach((item, index) => {
      const card = document.createElement('div');
      card.className = "bg-white rounded-2xl shadow-lg p-5 border hover:shadow-2xl transition";
      card.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-semibold text-lg text-blue-600">${item.department}</h3>
          <div class="flex space-x-2">
            <button class="text-yellow-500 hover:text-yellow-600 edit-btn" data-index="${index}"><i data-lucide="edit"></i></button>
            <button class="text-red-600 hover:text-red-700 delete-btn" data-index="${index}"><i data-lucide="trash"></i></button>
          </div>
        </div>
        <p class="text-sm text-gray-700">üìç Location: ${item.location}</p>
        <p class="text-sm text-gray-700">üì¶ Quantity: ${item.quantity}</p>
        <p class="text-sm text-gray-700">üí∞ Cost: ‚Ç±${item.acquisitionCost}</p>
        <p class="text-sm text-gray-700">üîß Status: ${item.status}</p>
        <p class="text-sm text-gray-700 mb-2"># Serial: ${item.serialNo}</p>
        <p class="text-xs text-gray-500 italic">${item.description}</p>
        <div class="flex flex-col items-center mt-4 space-y-2">
          <div id="qr-${index}" class="bg-gray-100 p-3 rounded-lg shadow-inner"></div>
          <button class="download-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-lg shadow" data-index="${index}">
            <i data-lucide="download" class="w-3 h-3 inline-block mr-1"></i> Download QR
          </button>
        </div>
      `;
      itemList.appendChild(card);
      new QRCode(document.getElementById(`qr-${index}`), { text: JSON.stringify(item), width: 100, height: 100 });
    });
    lucide.createIcons();

    document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => editItem(e.currentTarget.dataset.index)));
    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteItem(e.currentTarget.dataset.index)));
    document.querySelectorAll('.download-btn').forEach(btn => btn.addEventListener('click', e => downloadQR(e.currentTarget.dataset.index)));
  }

  function editItem(index) {
    const item = items[index];
    editIndex = index;
    Department.value = item.department;
    Location.value = item.location;
    Quantity.value = item.quantity;
    AcquisitionCost.value = item.acquisitionCost;
    DateAcquired.value = item.dateAcquired;
    Status.value = item.status;
    Accountable.value = item.accountable;
    SerialNo.value = item.serialNo;
    Description.value = item.description;
    modalTitle.textContent = "Edit Item";
    itemModal.classList.remove('hidden');
  }

  function deleteItem(index) {
    if (confirm("Delete this item?")) {
      items.splice(index, 1);
      saveItems();
      renderList();
    }
  }

  function downloadQR(index) {
    const img = document.getElementById(`qr-${index}`).querySelector('img');
    if (!img) return alert("QR not ready yet.");
    const link = document.createElement('a');
    link.href = img.src;
    link.download = `${items[index].department}_QR.png`;
    link.click();
  }

  // Load server-generated device QRs
  async function loadDeviceQRs() {
    try {
      const response = await fetch('/get_all_device_qrs');
      const devices = await response.json();

      const container = document.getElementById('itemList');
      container.innerHTML = '';

      devices.forEach(device => {
        const card = document.createElement('div');
        card.className = "bg-white rounded-2xl shadow p-5 border hover:shadow-xl transition";
        card.innerHTML = `
          <h3 class="font-bold text-blue-600 mb-2">${device.item_name}</h3>
          <p class="text-sm text-gray-700">Brand: ${device.brand_model}</p>
          <p class="text-sm text-gray-700">Serial: ${device.serial_number}</p>
          <p class="text-sm text-gray-700">Status: ${device.status}</p>
           <img src="/device_qr/${device.accession_id}" class="mt-3 border rounded shadow" alt="QR">
        `;
        container.appendChild(card);
      });
    } catch (err) {
      console.error('Error loading device QRs:', err);
    }
  }

  // Choose one to load depending on your use case:
  // loadItems();       // LocalStorage version
 await loadDeviceQRs(); // Server version

});
</script>


</body>
</html>
