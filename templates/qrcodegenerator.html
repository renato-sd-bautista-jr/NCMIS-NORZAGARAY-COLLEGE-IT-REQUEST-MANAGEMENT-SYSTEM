<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Code Generator - NCMIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="flex min-h-screen bg-gray-100 text-gray-800">

  {% include 'sidebar.html' %}

  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black/40 hidden z-40 md:hidden"></div>

  <!-- Main -->
  <main class="flex-1 ml-0 md:ml-64 p-6 space-y-6 transition-all duration-300">

    <!-- Header -->
    <header class="flex items-center justify-between bg-blue-700 text-white shadow-lg p-4 rounded-xl sticky top-4 z-30 border border-blue-800 backdrop-blur-md">
      <div class="flex items-center gap-2 font-medium">
        <i data-lucide="qr-code" class="w-6 h-6 text-white"></i>
        <h2 class="text-2xl font-bold">Device QR Codes</h2>
      </div>

      <!-- Scan QR Button -->
      <button id="scanQRBtn"
        class="flex items-center gap-2 bg-white hover:bg-gray-100 text-blue-700 px-4 py-2 rounded-lg shadow transition focus:ring-2 focus:ring-blue-300 focus:ring-offset-1 focus:ring-offset-blue-700">
        <i data-lucide="camera" class="w-4 h-4"></i>
        <span class="font-medium">Scan QR</span>
      </button>
    </header>

    <!-- Devices Grid -->
    <section class="bg-white rounded-2xl shadow-lg p-4">
      <div id="deviceGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </section>
  </main>

  <!-- QR Modal -->
  <div id="qrModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-80 text-center relative">
      <button id="closeQRModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      <h3 class="font-semibold text-blue-700 mb-4" id="qrDeviceName">Device Name</h3>
      <img id="qrImage" class="mx-auto border rounded-lg shadow" alt="QR Code">
    </div>
  </div>

  <!-- Scan QR Modal (Placeholder) -->
  <div id="scanModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 text-center">
      <button id="closeScanModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      <h3 class="font-semibold text-blue-700 mb-4">Scan or Upload QR</h3>
      <p class="text-gray-600 mb-4">Scanner feature coming soon</p>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Upload QR</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  lucide.createIcons();

  const deviceGrid = document.getElementById('deviceGrid');
  const qrModal = document.getElementById('qrModal');
  const qrImage = document.getElementById('qrImage');
  const qrDeviceName = document.getElementById('qrDeviceName');
  const closeQRModal = document.getElementById('closeQRModal');

  const scanModal = document.getElementById('scanModal');
  const scanQRBtn = document.getElementById('scanQRBtn');
  const closeScanModal = document.getElementById('closeScanModal');

  // Fetch devices
  try {
    const response = await fetch('/get_all_device_qrs');
    const devices = await response.json();
    deviceGrid.innerHTML = '';

    devices.forEach(device => {
      const card = document.createElement('div');
      card.className = "bg-white rounded-2xl shadow p-3 border hover:shadow-lg cursor-pointer flex flex-col items-center transition";
      card.innerHTML = `
        <h4 class="font-bold text-blue-700 text-sm text-center mb-1">${device.item_name}</h4>
        <p class="text-xs text-gray-700 text-center mb-2">${device.brand_model}</p>
        <img src="/device_qr/${device.accession_id}" class="w-20 h-20 mb-2" alt="QR">
        <p class="text-xs text-gray-600">Status: ${device.status}</p>
      `;
      card.addEventListener('click', () => {
        qrDeviceName.textContent = device.item_name;
        qrImage.src = `/device_qr/${device.accession_id}`;
        qrModal.classList.remove('hidden');
      });
      deviceGrid.appendChild(card);
    });
  } catch(err) {
    deviceGrid.innerHTML = '<p class="text-red-500">Failed to load devices.</p>';
    console.error(err);
  }

  // Close QR modal
  closeQRModal.addEventListener('click', () => qrModal.classList.add('hidden'));

  // Scan QR modal
  scanQRBtn.addEventListener('click', () => scanModal.classList.remove('hidden'));
  closeScanModal.addEventListener('click', () => scanModal.classList.add('hidden'));
});
</script>
</body>
</html>
