<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- PC Modal -->
<div id="pcModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 transition-all duration-300">
  <div id="pcModalContent" class="bg-white p-8 rounded-2xl w-full max-w-5xl shadow-2xl overflow-y-auto max-h-[90vh] transform scale-95 transition-transform duration-300">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6 border-b pb-3">
      <div class="flex items-center gap-3">
        <i data-lucide="computer" class="w-6 h-6 text-blue-600"></i>
        <h3 id="modalTitle" class="text-2xl font-semibold text-blue-600">Add PC</h3>
      </div>
      <button type="button" onclick="closePcModal()" class="text-gray-500 hover:text-gray-700 transition">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>

    <!-- Form -->
    <form id="pcForm" class="space-y-6">
      <input type="hidden" id="modalPcId" name="pcid">

      <!-- Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label">PC Name</label>
          <input type="text" id="modalPcName" name="pcname" required class="input">
        </div>

        <div>
          <label class="label">Department</label>
          <select id="modalDepartment" name="department_id" required class="input">
            <option value="">Select Department</option>
            {% for dep in departments %}
            <option value="{{ dep.department_id }}">{{ dep.department_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="label">Location</label>
          <input type="text" id="modalLocation" name="location" class="input" placeholder="e.g., IT Office">
        </div>

        <div>
          <label class="label">Quantity</label>
          <input type="number" id="modalQuantity" name="quantity" min="1" value="1" class="input">
        </div>

        <div>
          <label class="label">Acquisition Cost (‚Ç±)</label>
          <input type="number" id="modalAcquisitionCost" name="acquisition_cost" step="0.01" min="0" class="input" placeholder="e.g., 35000">
        </div>

        <div>
          <label class="label">Date Acquired</label>
          <input type="date" id="modalDateAcquired" name="date_acquired" class="input">
        </div>

        <div>
          <label class="label">Accountable</label>
          <input type="text" id="modalAccountable" name="accountable" class="input" placeholder="e.g., John Doe">
        </div>

        <div>
          <label class="label">Serial No</label>
          <input type="text" id="modalSerialNo" name="serial_no" class="input" placeholder="e.g., SN-123456">
        </div>

        <div>
          <label class="label">Municipal Serial No</label>
          <input type="text" id="modalMunicipalSerialNo" name="municipal_serial_no" class="input" placeholder="e.g., MSN-987654">
        </div>

        <div>
          <label class="label">Status</label>
          <select id="modalStatus" name="status" class="input">
            <option value="Available">Available</option>
            <option value="Inactive">Inactive</option>
            <option value="In Used">In Used</option>
            <option value="Damaged">Damaged</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="label">Note</label>
          <textarea id="modalNote" name="note" rows="2" class="input"></textarea>
        </div>
      </div>

      <hr class="my-6 border-gray-300">

      <!-- PC Parts -->
      <div>
        <div class="flex items-center gap-2 mb-3">
          <i data-lucide="cpu" class="w-5 h-5 text-blue-600"></i>
          <h4 class="text-lg font-semibold text-blue-600">PC Parts</h4>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          {% for part in ['Monitor', 'Motherboard', 'RAM', 'Storage', 'GPU', 'PSU', 'Casing', 'Other Parts'] %}
          <div>
            <label class="label">{{ part }}</label>
            <input type="text" id="{{ part|lower|replace(' ', '_') }}" name="{{ part|lower|replace(' ', '_') }}" class="input">
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Batch Add -->
      <div id="batchAddSection" class="hidden mt-4">
        <label class="label">Number of identical PCs to add</label>
        <input type="number" id="batchCount" name="batch_count" value="1" min="1" class="input">
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-3 mt-8 pt-4 border-t">
        <button type="button" onclick="toggleBatchAdd()" class="btn-blue">
          <i data-lucide="layers" class="w-4 h-4"></i> Batch Add
        </button>

        <div class="flex gap-3">
          <button type="button" onclick="closePcModal()" class="btn-gray">
            <i data-lucide="x-circle" class="w-4 h-4"></i> Cancel
          </button>
          <button id="modalSubmitBtn" type="submit" class="btn-blue">
            <i data-lucide="save" class="w-4 h-4"></i> Add PC
          </button>
        </div>
        
      </div>
    </form>
  </div>
</div>

<style>
.label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #374151; /* Dark gray for labels */
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.5rem;
  background-color: #ffffff;
  color: #000000; /* Text color black */
  placeholder-color: #9ca3af;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.input::placeholder {
  color: #9ca3af; /* Gray placeholder */
}

.input:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); /* Blue focus ring */
  outline: none;
}

.btn-blue {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background-color: #2563eb;
  color: white;
  padding: 0.5rem 1.25rem;
  border-radius: 0.5rem;
  transition: background-color 0.2s;
}

.btn-blue:hover {
  background-color: #1e40af;
}

.btn-gray {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background-color: #9ca3af;
  color: white;
  padding: 0.5rem 1.25rem;
  border-radius: 0.5rem;
  transition: background-color 0.2s;
}

.btn-gray:hover {
  background-color: #6b7280;
}
</style>


<script>
async function openPcModal(pcData = null) {
  const modal = document.getElementById('pcModal');
  const modalTitle = document.getElementById('modalTitle');
  const form = document.getElementById('pcForm');
  const submitBtn = document.getElementById('modalSubmitBtn');
  const departmentSelect = document.getElementById('modalDepartment');
  const res = await fetch('/notifications/get_notifications');

  // Reset form first
  form.reset();

  // üîπ Fetch departments dynamically
  try {
    const depResponse = await fetch("/get-departments");
    const departments = await depResponse.json();

    // Clear and repopulate dropdown
    departmentSelect.innerHTML = '<option value="">Select Department</option>';
    departments.forEach(dep => {
      const opt = document.createElement("option");
      opt.value = dep.department_id;
      opt.textContent = dep.department_name;
      departmentSelect.appendChild(opt);
    });
  } catch (err) {
    console.error("‚ùå Failed to load departments:", err);
  }

  // üü¶ EDIT MODE
  if (pcData) {
    modalTitle.textContent = "Edit PC";
    form.action = "{{ url_for('manage_pc_bp.update_pcinfofull') }}";
    submitBtn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> Update PC';

    const fieldMap = {
      pcid: 'modalPcId',
      pcname: 'modalPcName',
      department_id: 'modalDepartment',
      location: 'modalLocation',
      quantity: 'modalQuantity',
      acquisition_cost: 'modalAcquisitionCost',
      date_acquired: 'modalDateAcquired',
      accountable: 'modalAccountable',
      serial_no: 'modalSerialNo',
      municipal_serial_no: 'modalMunicipalSerialNo',
      status: 'modalStatus',
      note: 'modalNote',
      monitor: 'monitor',
      motherboard: 'motherboard',
      ram: 'ram',
      storage: 'storage',
      gpu: 'gpu',
      psu: 'psu',
      casing: 'casing',
      other_parts: 'other_parts'
    };

    for (const [key, inputId] of Object.entries(fieldMap)) {
      const element = document.getElementById(inputId);
      if (element) {
        let value = pcData[key] ?? '';
        if (key === 'date_acquired' && value) {
          const dateObj = new Date(value);
          value = dateObj.toISOString().split('T')[0];
        }
        element.value = value;
      }
    }

    // üß© Select department by ID
    if (pcData.department_id) {
      departmentSelect.value = pcData.department_id;
    }

  } else {
    // üü© ADD MODE
    modalTitle.textContent = "Add PC";
    form.action = "{{ url_for('manage_pc_bp.add_pcinfofull') }}";
    submitBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Add PC';
  }

  // ü™ü Show modal
  modal.classList.remove('hidden');
  setTimeout(() => document.getElementById('pcModalContent').classList.add('scale-100'), 50);
  lucide.createIcons();
  
}
function closePcModal() {
  document.getElementById('pcModal').classList.add('hidden');
}
document.getElementById("pcForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const pcid = formData.get("pcid"); // will be filled during edit
  const batchCount = parseInt(document.getElementById("batchCount").value || "1", 10);

  // üü° If editing an existing PC
  if (pcid) {
    try {
      const res = await fetch("{{ url_for('manage_pc_bp.update_pcinfofull') }}", {
        method: "POST",
        body: formData
      });
      if (res.ok) {
        showPopup("success", "PC updated successfully!");
        setTimeout(() => window.location.reload(), 1500);
      } else {
        const data = await res.json();
        showPopup("error", data.error || "Failed to update PC.");
      }
    } catch (err) {
      console.error("‚ùå Update error:", err);
      showPopup("error", "Something went wrong while updating PC.");
    }
    return; // Stop here
  }

  // üü© ADD MODE (supports batch add)
  if (batchCount > 1) {
    // Batch add logic...
    const baseName = formData.get("pcname").trim() || "PC";
    const batchPcs = [];

    for (let i = 1; i <= batchCount; i++) {
      const pcCopy = Object.fromEntries(formData.entries());
      pcCopy.pcname = `${baseName}-${String(i).padStart(2, "0")}`;
      pcCopy.serial_no = generateSerial("SN");
      pcCopy.municipal_serial_no = generateSerial("MSN");
      batchPcs.push(pcCopy);
    }

    try {
      const res = await fetch("{{ url_for('manage_pc_bp.batch_add_pcinfofull') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(batchPcs)
      });
      const data = await res.json();

      if (data.success) {
        showPopup("success", `${batchCount} PCs added successfully!`);
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showPopup("error", data.error || "Batch add failed.");
      }
    } catch (err) {
      console.error("‚ùå Batch Add Error:", err);
      showPopup("error", "Something went wrong during batch add.");
    }

  } else {
    // Single Add
    try {
      const res = await fetch("{{ url_for('manage_pc_bp.add_pcinfofull') }}", {
        method: "POST",
        body: formData
      });
      const data = await res.json();

      if (!res.ok) {
        showPopup("error", data.error || "Failed to add PC.");
        openPcModal(Object.fromEntries(formData));
        return;
      }

      showPopup("success", data.message);
      setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
      console.error("‚ùå Submission error:", err);
      showPopup("error", "Something went wrong while adding PC.");
    }
  }
});


function showPopup(type, message) {
  const popup = document.createElement("div");
  popup.className = `fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg text-white z-50 ${
    type === "error" ? "bg-red-600" : "bg-green-600"
  }`;
  popup.textContent = message;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 3000);
}

function toggleBatchAdd() {
  const batchSection = document.getElementById("batchAddSection");
  batchSection.classList.toggle("hidden");
}

/** Helper to generate unique serials */
function generateSerial(prefix = "SN") {
  const randomPart = Math.floor(100000 + Math.random() * 900000); // 6 digits
  return `${prefix}-${Date.now()}-${randomPart}`;
}
</script>


