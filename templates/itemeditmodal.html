<!-- Item Add/Edit Modal -->
<div id="itemModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-2xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh] border border-gray-200">
    <h3 id="modalTitle" class="text-xl font-semibold text-blue-600 mb-4 flex items-center gap-2">
      <i data-lucide="plus-circle"></i>
      <span>Add Device</span>
    </h3>

    <!-- Error Message -->
    <div id="itemModalError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4"></div>

    <form id="itemForm" method="post" class="space-y-4">
      <input type="hidden" name="accession_id" id="accession_id">

      <!-- Device Name -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Device Name</label>
        <input type="text" name="item_name" id="item_name" required
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Brand / Model -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Brand / Model</label>
        <input type="text" name="brand_model" id="brand_model"
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Serial No -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Serial No</label>
        <input type="text" name="serial_no" id="serial_no" readonly
          class="w-full p-2 rounded-lg border border-gray-300 bg-gray-100 text-gray-600 focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Municipal Serial No -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Municipal Serial No</label>
        <input type="text" name="municipal_serial_no" id="municipal_serial_no" readonly
          class="w-full p-2 rounded-lg border border-gray-300 bg-gray-100 text-gray-600 focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Quantity -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Quantity</label>
        <input type="number" name="quantity" id="quantity" value="1" min="1"
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Device Type -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Device Type</label>
        <input type="text" name="device_type" id="device_type"
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Acquisition Cost -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Acquisition Cost (â‚±)</label>
        <input type="number" step="0.01" name="acquisition_cost" id="acquisition_cost"
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Date Acquired -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Date Acquired</label>
        <input type="date" name="date_acquired" id="date_acquired"
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Accountable Person -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Accountable Person</label>
        <input type="text" name="accountable" id="accountable"
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
      </div>

      <!-- Department -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Facilities</label>
        <select name="department_id" id="department_id" required
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
          <option value="">Loading Facilities...</option>
        </select>
      </div>

      <!-- Status -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Status</label>
        <select name="status" id="status" required
          class="w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black">
          <option value="Available">Available</option>
          <option value="In Used">In Used</option>
          <option value="Inactive">Inactive</option>
          <option value="Damaged">Damaged</option>
        </select>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-3 mt-6">
        <button type="button" onclick="closeItemModal()"
          class="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm">
          Cancel
        </button>
        <button id="itemSubmitBtn" type="submit"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
          Add Device
        </button>
      </div>
    </form>
  </div>
</div>

<script>
async function openItemModal(itemData = null) {
  const modal = document.getElementById('itemModal');
  const title = document.getElementById('modalTitle');
  const form = document.getElementById('itemForm');
  const quantity = document.getElementById('quantity');
  const serialInput = document.getElementById('serial_no');
  const municipalInput = document.getElementById('municipal_serial_no');
  const submitBtn = document.getElementById('itemSubmitBtn');
  const deptSelect = document.getElementById('department_id');
  const statusSelect = document.getElementById('status');
  const errorDiv = document.getElementById('itemModalError');

  errorDiv.classList.add('hidden');
  errorDiv.textContent = '';

  // Reset form
  form.reset();
  
  document.getElementById('accession_id').value = '';

  serialInput.readOnly = false;

  
  // Load departments
  try {
    const res = await fetch('/get-departments');
    const departments = await res.json();
    deptSelect.innerHTML = '<option value="">Select Department</option>';
    departments.forEach(dep => {
      const opt = document.createElement('option');
      opt.value = dep.department_id;
      opt.textContent = dep.department_name;
      deptSelect.appendChild(opt);
    });
  } catch {
    deptSelect.innerHTML = '<option value="">Error loading departments</option>';
  }

  if (itemData) {
    // EDIT MODE
    title.innerHTML = '<i data-lucide="edit"></i><span>Edit Device</span>';
    form.action = "{{ url_for('manage_item_bp.update_device') }}";
    submitBtn.textContent = "Update Device";

    Object.entries(itemData).forEach(([key, value]) => {
      const input = document.getElementById(key);
      if (!input) return;
      if (key === 'date_acquired' && value && value !== "0000-00-00") {
        const dateObj = new Date(value);
        input.value = dateObj.toISOString().split('T')[0];
      } else {
        input.value = value ?? '';
      }
    });

    serialInput.readOnly = false;
    serialInput.classList.remove('bg-gray-100');
    municipalInput.readOnly = false;
    municipalInput.classList.remove('bg-gray-100');
    quantity.readOnly = true;
    quantity.classList.add('bg-gray-100', 'cursor-not-allowed');
  } else {
    // ADD MODE
    title.innerHTML = '<i data-lucide="plus-circle"></i><span>Add Device</span>';
    form.action = "{{ url_for('manage_item_bp.add_device') }}";
    submitBtn.textContent = "Add Device";

    quantity.readOnly = false;
    quantity.value = 1;
    quantity.classList.remove('bg-gray-100', 'cursor-not-allowed');

    // Generate Serials
    function generateSerial(prefix="SN") {
      return prefix + Date.now().toString().slice(-6) + Math.floor(Math.random()*100);
    }

    serialInput.value = generateSerial("SN");
    municipalInput.value = generateSerial("MSN");
    serialInput.readOnly = true;
    municipalInput.readOnly = true;
    serialInput.classList.add('bg-gray-100');
    municipalInput.classList.add('bg-gray-100');
  }

  lucide.createIcons();
  modal.classList.remove('hidden');
}

// CLOSE MODAL
function closeItemModal() {
  const modal = document.getElementById('itemModal');
  modal.classList.add('hidden');
}

// SUBMIT FORM WITH DUPLICATE CHECK
document.getElementById("itemForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const form = e.target;
  const errorDiv = document.getElementById('itemModalError');
  errorDiv.classList.add('hidden');
  errorDiv.textContent = '';

  const data = new FormData(form);
  const serial_no = data.get('serial_no');
  const municipal_serial_no = data.get('municipal_serial_no');
  const accession_id = data.get('accession_id');

  try {
    // Check duplicate serial no or municipal serial no
    const res = await fetch(`/manage_inventory/check-serial-duplicate?serial_no=${encodeURIComponent(serial_no)}&municipal_serial_no=${encodeURIComponent(municipal_serial_no)}&accession_id=${accession_id || ''}`);
    const result = await res.json();

    if (result.duplicate) {
      errorDiv.textContent = "Serial No or Municipal Serial No already exists!";
      errorDiv.classList.remove('hidden');
      return; // stop submission
    }

    // Submit form via fetch
    const actionUrl = form.action;
    const formData = new URLSearchParams(data);
    const submitRes = await fetch(actionUrl, { method: 'POST', body: formData });
    if (!submitRes.ok) throw new Error(`HTTP ${submitRes.status}`);

    // Reload or refresh the table
    location.reload();
  } catch (err) {
    console.error(err);
    errorDiv.textContent = "Error submitting form. See console.";
    errorDiv.classList.remove('hidden');
  }
});
</script>
